<!doctype html>
<html lang="ru">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <link rel="stylesheet" href="styles/reset.css">
    <link rel="stylesheet" media="screen" href="styles/display.css">
    <link rel="stylesheet" media="print" href="styles/print.css">
    <link rel="stylesheet" href="styles/slides.css">
  </head>
  <body>
    <article class="presentation">
      <nav>
        <h2> Содержание </h2>
        <ol>
        </ol>
      </nav>

      <button class="fullscreen" title="fullscreen"> 
        <img src="resize.svg" alt="fullscreen"> 
      </button>

      <section class="slides"> 
        <div class="container">
          <section class="slide" id="intro" data-name="Начало">
            <h1><span>П</span><span>р</span><span>о</span><span>в</span><span>е</span><span>р</span><span>к</span><span>и</span><span>.</span></h1>
              <figure>
                <img src="ministry-of-justice-emblem.png">
              </figure>
          </section>
        </div>
        
        <div class="container">
          <section class="slide" id="initial-response">
            <h2> к вам пришли представители госорганов 
                 как их встречать? </h2>
            <ul>
              <li>
                обязательная вежливая и внимательная проверка 
                документов и служебных удостоверений, 
                данные которых переписываются.
              </li>
              <li>
                регистрация в вахтовой книге, тетради учета посетителей или аналогичной 
                (не путайте с журналом учета проверок, 
                 туда записи вносятся по окончании проверки).
              </li>
              <li>
                доклад руководителю и представителю администрации 
                уполномоченному общаться с проверяющими.
              </li>
            </ul>
          </section>
        </div>


        <div class="container">
          <section class="slide">
            <h2>  3 </h2>
          </section>
        </div>

        <div class="container">
          <section class="slide">
            <h2>  4 </h2>
          </section>
        </div>

        <div class="container">
          <section class="slide">
            <h2>  5 </h2>
          </section>
        </div>

        <div class="container">
          <section class="slide">
            <h2>  6 </h2>
          </section>
        </div>

        <div class="container">
          <section class="slide">
            <h2>  7 </h2>
          </section>
        </div>

        <div class="container">
          <section class="slide">
            <h2>  8 </h2>
          </section>
        </div>

        <div class="container">
          <section class="slide">
            <h2>  9 </h2>
          </section>
        </div>

        <div class="container">
          <section class="slide">
            <h2>  10 </h2>
          </section>
        </div>

        <div class="container">
          <section class="slide">
            <h2>  11 </h2>
          </section>
        </div>

        <div class="container">
          <section class="slide">
            <h2>  12 </h2>
          </section>
        </div>

        <div class="container">
          <section class="slide">
            <h2>  13 </h2>
          </section>
        </div>

        <div class="container">
          <section class="slide">
            <h2>  14 </h2>
          </section>
        </div>

        <div class="container">
          <section class="slide">
            <h2>  15 </h2>
          </section>
        </div>

        <div class="container">
          <section class="slide">
            <h2>  16 </h2>
          </section>
        </div>

        <div class="container">
          <section class="slide">
            <h2>  17 </h2>
          </section>
        </div>

        <div class="container">
          <section class="slide">
            <h2>  18 </h2>
          </section>
        </div>



        <div class="container">
          <section class="slide">
            <h2>  19 </h2>
          </section>
        </div>

        <div class="container">
          <section class="slide">
            <h2>  20 </h2>
          </section>
        </div>

        <div class="container">
          <section class="slide">
            <h2>  21 </h2>
          </section>
        </div>

        <div class="container">
          <section class="slide">
            <h2>  22 </h2>
          </section>
        </div>

        <div class="container">
          <section class="slide">
            <h2>  23 </h2>
          </section>
        </div>

        <div class="container">
          <section class="slide">
            <h2>  24 </h2>
          </section>
        </div>

        <div class="container">
          <section class="slide">
            <h2>  25 </h2>
          </section>
        </div>

        <div class="container">
          <section class="slide">
            <h2>  26 </h2>
          </section>
        </div>

        <div class="container">
          <section class="slide">
            <h2>  27 </h2>
          </section>
        </div>

        <div class="container">
          <section class="slide">
            <h2>  28 </h2>
          </section>
        </div>

        <div class="container">
          <section class="slide">
            <h2>  29 </h2>
          </section>
        </div>

        <div class="container">
          <section class="slide">
            <h2>  30 </h2>
          </section>
        </div>

        <div class="container">
          <section class="slide">
            <h2>  31 </h2>
          </section>
        </div>

        <div class="container">
          <section class="slide">
            <h2>  32 </h2>
          </section>
        </div>

        <div class="container">
          <section class="slide">
            <h2>  33 </h2>
          </section>
        </div>

        <div class="container">
          <section class="slide">
            <h2>  34 </h2>
          </section>
        </div>
      </section>

    </article>
  <body>

  <script>
    class Slide {
      constructor(slide, index, id=null, name=null) {
        this.data = slide;
        this.index = index;
        
        this.setName(name);
        this.setId(id);

        const link = document.createElement("a");
        const li = document.createElement("li");
        const text = document.createElement("span");
        text.textContent = this.name();
        li.append(text);
        link.append(li);
        link.setAttribute("href", `#${this.id()}`);
        this.link = link;
      }

      firstHeader() {
        for (const index of [1, 2, 3, 4, 5, 6]) {
          const h = this.data.querySelector(`h${index}`);
          if (h !== null) {
            return h.textContent;
          }
        }
        return null;
      }

      setName(name) {
        return this.data.setAttribute("data-name", 
            name ?? this.data.getAttribute("data-name")
                 ?? this.firstHeader()
                 ?? `slide ${this.index + 1}`
        );
      }

      name() {
        return this.data.getAttribute("data-name")
      }
      
      setId(id) {
        this.data.setAttribute("id",
          id ?? this.data.getAttribute("id")
             ?? `slide-${this.index + 1}`
        );
      }

      id() {
        return this.data.getAttribute("id");
      }

      isSelected() {
        return this.link.classList.contains("current");
      }

      select() {
        this.link.classList.add("current");
      }
      unselect() {
        this.link.classList.remove("current");
      }
    }

    function Slides(presentation) {
      this.presentation = presentation;
      this.navList = this.presentation.querySelector("nav ol");
      this.slideWindow = this.presentation.querySelector(".slides");
      
      // register slides 
      const all = this.slideWindow
                      .querySelectorAll(".slide");
      this.slides = [...all].map(
        (data, index) => new Slide(data, index));

      // activate navigation 
      this.slides.forEach(
        slide => this.navList.append(slide.link));
      this.length = this.slides.length;
      this.actualize();
      
      this.slideWindow.addEventListener(
        "scroll", 
        () => this.actualize()
      );

      const isChromium = !!window.chrome;
      this.slideWindow.addEventListener(
            isChromium? "scrollend" : "scroll", 
            () => this.current.link.scrollIntoView({
              behavior: "auto",
              inline: "center"
            })
      );
    }

    Slides.prototype.actualize = function() {
      const slideWidth = this.slideWindow.scrollWidth / (this.length);
      const index = Math.round(this.slideWindow.scrollLeft / slideWidth);
      
      if (this.current) {
        this.current.unselect();
      }

      this.current = this.slides[index]; 
      this.current.select();
    };

    const slides = new Slides(document.querySelector("article"));
    if (slides.slideWindow.requestFullscreen) {
      document.querySelector(".fullscreen").addEventListener(
            "click", 
            () => slides.slideWindow.requestFullscreen()
      );
    } else {
      document.querySelector(".fullscreen").style.display = "none";
    }
  </script>

  <script>

    const intro = document.querySelector("#intro");
    const cells = [...intro.querySelectorAll("h1 span")];
    const dot = intro.querySelector("h1 .dot");

    /* hardcoded */
    const original = [
      [1, 1], [1, 2], [2, 1],
      [1, 3], [2, 2], [2, 3],
      [3, 1], [3, 2], [3, 3]
    ];

    let coords = [...original];

    function find(pos) {
      return coords.findIndex((p) => p[0] == pos[0] && p[1] == pos[1]);
    }
    
    function pick(a) {
      return a[Math.round(Math.random() * (a.length - 1))];
    }

    function current() {
      return coords[coords.length - 1];
    }
    
    function calc(pos, move) {
      const [x, y] = pos;
      const [dx, dy] = move;
      return [x + dx, y + dy];
    }

    function valid(pos, move) {
      const [x, y] = calc(pos, move);
      return (1 <= x && x <= 3)
          && (1 <= y && y <= 3);
    }
    
    function move(src) {
      const moves = [[0, 1], [0, -1], [1, 0], [-1, 0]];
      let move = pick(moves);
      while (!valid(src, move)) {
        move = pick(moves);
      }

      return move;
    }

    function reorderOnScreen(positions) {
      for (let i = 0; i < cells.length; i++) {
        const [row, column] = positions[i];
        cells[i].style.gridRow = row;
        cells[i].style.gridColumn = column;
      }
    }
    
    function swap(src, dest) {
      const i = find(src);
      const j = find(dest);
      coords[i] = dest;
      coords[j] = src;
    }

    let iteration = 0;

    function lex([a, b], [c, d]) {
      if (a < c) {
        return -1;
      }
      if ((a === c) &&  b < d) {
        return -1;
      } else if ((a===c) & b===d) {
        return 0;
      }
      return 1;
    }

    function cycle() {
      
      const before = dump();

      
      
      if (iteration % 3 === 0) {

        coords = 
          [...coords.slice(0, 3).sort(lex), 
           ...coords.slice(3, 6).sort(lex), 
           ...coords.slice(6, 8).sort(lex), 
           ...coords.slice(8, 9)];
        console.log(coords);
      } else {
        const src = current();
        const dest = calc(src, move(src));
        swap(src, dest); 
      }

      reorderOnScreen(coords);
      
      const after = dump();

      animate(before, after);
      iteration += 1;
    }

    function dump() {
      return cells.map(e => e.getBoundingClientRect()); 
    }
    
    function animate(cold, cnew) {
      for (let i = 0; i < cells.length; i++) {
          const dx = cold[i].x - cnew[i].x;
          const dy = cold[i].y - cnew[i].y;
          
          if (Math.abs(dx) < 1e-2 && Math.abs(dy) < 1e-2) {
            continue;
          }

          cells[i].animate([{
            transformOrigin: 'top left',
            transform: `translate(${dx}px, ${dy}px)`
          }, {
            transformOrigin: 'top left',
            transform: 'none'
          }], {
            duration: 300,
            easing: 'ease-in-out'
          });
      }
    }
    
    let id = setInterval(cycle, 600);
    
    window.addEventListener(
      "beforeprint",
      () => {
        clearInterval(id);
        cells.forEach(c => c.getAnimations().forEach(a => a.cancel()));
        reorderOnScreen(original);
    });

    window.addEventListener(
      "afterprint",
      () => {
        reorderOnScreen(coords);
        id = setInterval(cycle, 600);
      }
    );

  </script>
</html>
